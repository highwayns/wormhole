# ワームホールノードの実行

！[](images/nodearchitecture.svg)

## 接続されたチェーン

ワームホール自体に加えて、ワームホールが接続するすべてのチェーンに対して独自の検証ノードを実行する必要があります。

-**ソラナ**。 Solanaのライトクライアントはまだないため、完全なsolana-validatorノードを実行する必要があります。それはしません
  実際にはバリデーターである必要があります-バリデーターでない場合は、非検証モードでsolana-validatorを実行できます。

  バリデーターの実行方法については、[Solanaのドキュメント](https://docs.solana.com/running-validator)を参照してください。バリデーター
  ドキュメントに記載されている要件は過剰です-mainnet-betaの現在のイテレーションでは、「ローエンド」構成
  GPUがない場合は完全に適切であり、十分な予備容量があります。
  [SolanaのDiscordサーバー](https://solana.com/community)は、バリデーター操作に関する質問に最適なリソースです。

-**イーサリアム**。以下を参照してください-少なくとも軽いクライアントが必要です。安定性の理由から、フルノードをお勧めします。

-** Terra **には、フルノードと[LCDサーバー](https://docs.terra.money/terracli/lcd.html#light-client-daemon)が必要です。
  フルノードを指しています。 [Terraドキュメント](https://docs.terra.money/node/join-network.html)を参照してください
  フルノードを実行する方法について。セキュリティの観点から、 `--trust-node = false`が指定されたLCDサーバーのみを実行する
  他の誰かの完全なノードに十分ですが、可用性についてはその単一のノードに依存します。
  ノードのセットを指すロードバランサーを設定します。

-** Binance Smart Chain **：イーサリアムと同じ要件。 BSCはイーサリアムよりもスループットが高いことに注意してください
  およそ2倍のコンピューティングリソースが必要です。

**どのチェーンにもサードパーティのRPCサービスプロバイダーを使用しないでください**。あなたは彼らを完全に信頼するでしょう、そして彼らは嘘をつくことができます
イベントが実際に観察されたかどうかを確認します。ワームホールの要点は、集中型ノードに依存しないことです。

テストネットとメインネットの両方で独自のフルノードを実行することを強くお勧めします(該当する場合)
そのため、メインネットのフルノードの変更をテストして、運用経験を積むことができます。

### Solanaノードの要件

Solana RPCノードでは、次のパラメーターを有効にする必要があります。 

```
--enable-rpc-transaction-history
--enable-cpi-and-log-storage
```

`--enable-rpc-transaction-history`を使用すると、* getConfirmedBlock * APIを介して履歴トランザクションを取得できます。
これは、ワームホールがトランザクションを見つけるために必要です。

`--enable-cpi-and-log-storage`は、CPI呼び出しに関するメタデータを格納します。

これらには追加のディスク容量が必要であることに注意してください。

#### アカウントインデックス

Wormhole v1に同じRPCノードを使用する場合は、速度を上げるために次の追加パラメーターも必要です。
`getProgramAccount`クエリ： 

```
[... see above for other required parameters ...]

--account-index program-id
--account-index-include-key WormT3McKhFJ2RkiGpdw9GKvNCrB2aB54gb2uV9MfQC   # for mainnet
--account-index-include-key 5gQf5AUhAgWYgUCt9ouShm9H7dzzXUsLdssYwe5krKhg  # for testnet
```

または、ワームホールだけでなく、すべてのプログラムのインデックスを使用して汎用RPCノードを実行する場合は、
フィルタリングを省略します。 

```
--account-index program-id
```

メインネットでは、キャッチアップを高速化するために、KINとトークンプログラムをブラックリストに登録することを強くお勧めします。 

```
--account-index-exclude-key kinXdEcpDQeHPEuQnqmUgtYykqKGVFq6CeVX5iAHJq6  # Mainnet only
--account-index-exclude-key TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA  # Mainnet only
```

これらのインデックスには追加のディスク領域が必要であり、キャッチアップが遅くなる可能性があることに注意してください。後の最初のスタートアップ
Solanaはすべてのインデックスを再作成する必要があるため、これらのパラメータの追加は遅くなります。

### イーサリアムノードの要件

イーサリアムチェーン上のイベントを監視するには、イーサリアムRPCエンドポイントにアクセスする必要があります。最も一般的な
選択はゲスですが、多様性のために、ゲスではない何かを実行したい場合があります。

Alchemy、InfuraなどのRPCプロバイダーを使用すると、これらのオペレーターが改ざんされていないチェーンデータを提供することを信頼します。
正しさを確認する方法はありません。したがって、ワームホールにはイーサリアムフルノードまたはライトクライアントのいずれかが必要です。 The
ノードは、ブリッジソフトウェアのセキュリティやパフォーマンスに影響を与えることなく、フルモード、クイックモード、またはライトモードで操作できます。
ノードがEthereumJSON RPC APIをサポートしている限り、ブリッジと互換性があるため、すべてのメジャー
実装は正常に機能します。

一般に、フルノードは、DoS攻撃の影響を受けやすいライトクライアントよりもうまく機能し、信頼性が高くなります。
ライトクライアントプロトコルをサポートするノードはごくわずかであるためです。

フルノードを実行するには、通常、最大500GのSSDストレージ、8GのRAM、および4〜8個のCPUスレッドが必要です(クロックによって異なります)。
周波数)。ライトクライアントのハードウェア要件ははるかに低くなります。

## 建物の保護者

セキュリティ上の理由から、ビルド済みのバイナリは提供していません。リポジトリをチェックアウトして、
ソースからのguardiandバイナリ。 Gitリポジトリは、リリースバイナリよりも改ざんするのがはるかに困難です。

ワームホールノードを構築するには、[Go](https://golang.org/dl/)> = 1.17.0が必要です。

まず、デプロイするワームホールリポジトリのバージョンを確認します。 

```bash
git clone https://github.com/certusone/wormhole && cd wormhole
git checkout v2.0.x
```

次に、非特権ビルドユーザーとしてリリースバイナリをコンパイルします。 

```bash
make node
```
    
最終的には `build/`に `guardiand`バイナリが含まれます。

盲目的に従うべきチュートリアルではなく、これらの推奨事項を検討してください。あなたはこれをあなたの
既存のビルドパイプライン。 Dockerfileの例が必要な場合は、devnetのデプロイをご覧ください。

ローカルでコンパイルしてデプロイする場合は、 `sudo make install`を実行して、バイナリを/usr/local/binにインストールできます。

カスタムパイプラインを使用してデプロイする場合は、バイナリに `CAP_IPC_LOCK`機能を設定する必要があります(例：
`sudo setcap cap_ipc_lock = + ep`)と同等であり、メモリページをロックしてページアウトを防止します。
理由については、以下を参照してください-これは、プロセスメモリがスワップアウトされないことを保証する一般的な多層防御の緩和策です
ディスクに。この追加機能が運用上またはコンプライアンス上の懸念を表す場合は、GitHubの問題を作成してください。

## キーの生成

ガーディアンキーを生成するには、最初にguardiandをインストールします。別のマシンでキーを生成する場合は、
それをインストールせずにのみguardiandをコンパイルします： 

    make node
    sudo setcap cap_ipc_lock=+ep ./build/bin/guardiand

それ以外の場合は、上記の通常の手順を使用してコンパイルしたものと同じguardiandバイナリを使用してください。

`keygen`サブコマンドを使用して新しいキーを生成します。

    guardiand keygen --desc "Testnet key foo"/path/to/your.key

キーファイルには、公開キーハッシュと説明を含む人間が読める部分が含まれています。

## デプロイ

ワームホールサービスには、個別のユーザーサービスとsystemdサービスを強くお勧めします。

例については、別の[wormhole-networks](https://github.com/certusone/wormhole-networks)リポジトリを参照してください
特定のネットワーク用に保護ユニットを設定する方法について。

P2Pネットワークのファイアウォールでポート8999/udpを開く必要があります。他に何も外部に公開する必要はありません。

journalctlは、バイナリ出力に `-a`フラグを使用して、guardiandの色付きの出力を表示できます。つまり、` journalctl -a -f -uguardiand`です。

### Kubernetes

Kubernetesのデプロイは完全にサポートされています。

独自の本番デプロイメントの開始点として、たとえばk8sデプロイメントなどの[devnet/](../devnet)を参照してください。あなたは
独自のコンテナを作成する必要があります。すでにKubernetesを本番環境で実行している場合を除き、従来の
専用インスタンスへのデプロイ-理解とトラブルシューティングが簡単です。

### モニタリング

ワームホールは、準備とメトリックのためにステータスサーバーを公開します。デフォルトでは、ローカルホストのポート6060でリッスンします。
コマンドライン引数を使用して、公開することができます： `--statusAddr = [::]：6060`。

#### `/readyz`

ワームホールノードがリクエストを処理する準備ができると、このエンドポイントは200OKステータスコードを返します。ノードは
すべてのチェーンに正常に接続し、リクエストの処理を開始するとすぐに準備ができていると見なされます。

これは**起動信号専用**です-*停止*したかどうかはわかりません
後でリクエストを処理します。それが真実になると、それは真実のままです！メトリックを使用してそれを把握します。

#### `/metrics`

このエンドポイントは、アラートとアラートのために[Prometheusメトリック](https://prometheus.io/docs/concepts/data_model/)を提供します
内省。 PrometheusとAlertmanagerを使用することをお勧めしますが、
標準化されたプロメテウスの解説形式が機能します。

ワームホールでより多くの運用経験を積んだら、適切な症状に基づく具体的な推奨事項
警告はここに文書化されます。

Grafanaダッシュボードの例については、[Wormhole.json](../dashboards/Wormhole.json)を参照してください。

**注：**監視のためにログ出力を解析することはお勧めしません。ログ出力は人間が消費するためのものであり、
安定したAPIとは見なされません。ログメッセージは、予告なしに追加、変更、または削除される場合があります。メトリックを使用します:-)

## パブリックAPIエンドポイントの実行

Wormhole v2は、データ可用性レイヤーとしてSolanaを使用しなくなりました([設計ドキュメント](../design/0005_data_availability.md)を参照)。
代わりに、Webウォレットや他のクライアントが署名されたVAAを取得するために使用できるAPIを公開するGuardianノードに依存しています
特定のトランザクションのメッセージ。

ガーディアンノードは、プロトコルの堅牢性を向上させるために、パブリックAPIエンドポイントを公開することを**強くお勧めします**。

guardiandには、組み込みのRESTおよびgrpc-webサーバーが付属しており、これらは `--publicWeb`フラグを使用して有効にできます。 

```
--publicWeb=[::]:443
```

Webウォレットで使用するには、TLSをサポートする必要があります。 guardiandには、Let'sEncryptのサポートが組み込まれています。 

```
--tlsHostname=wormhole-v2-mainnet-api.example.com
--tlsProdEnv=true
```

または、CloudFlareなどのマネージドリバースプロキシを使用してTLSを終了することもできます。

署名ノードでpublicWebポートを公開しても安全です。 サービス拒否攻撃に対する回復力を高めるために、
将来のguardiandリリースには、ガーディアンキーのない複数のguardiandインスタンスなどのリッスン専用モードが含まれる予定です。
ロードバランサーの背後で操作できます。

### systemdソケットのアクティブ化

guardiandは、オプションで、ポート443への非特権バインディングのsystemdソケットアクティベーションをサポートし、再起動します
最小限のダウンタイムで。

`--publicWeb`エンドポイントの前に` sd： `を付けることで有効にできます。 その後、guardiandは指定されたものを使用します
systemdによって提供されるソケット(例： `--publicWeb = sd：[::]：443`)。

メインの `guardiand.service`にバインドされた2番目のsystemdユニットが必要です。 

```
#/etc/systemd/system/guardiand-web.socket

[Socket]
ListenStream=443
Service=guardiand.service

[Install]
WantedBy=sockets.target
```

...そしてそれを有効にします： `systemctl enable--nowguardiand-web.socket`。 `guardiand.service`も再起動する必要があります。

### 特権ポートへのバインド

上記のようにソケットアクティベーションを使用せずに `--publicWeb`を1024未満のポートにバインドする場合は、次のように割り当てる必要があります。
CAP_NET_BIND_SERVICE機能。 これは、バイナリに機能を追加することで実現できます
(非システム環境のように)： 

     sudo setcap cap_net_bind_service=+ep guardiand

...または `guardiand.service`で設定された機能を拡張することによって： 

    AmbientCapabilities=CAP_IPC_LOCK CAP_NET_BIND_SERVICE
    CapabilityBoundingSet=CAP_IPC_LOCK CAP_NET_BIND_SERVICE

## キー管理

次のキーを管理する必要があります。

 -ブリッジコンセンサスキーである**ガーディアンキー**。このキーは非常に重要です-ノードはそれを使用して認証します
   VAAメッセージ。公開鍵のハッシュは、接続されているすべてのチェーンの保護者セットに保存されます。報酬は発生しません。
   ワームホールネットワークを保護するのは、マルチシグメカニズムの共有です。ガーディアンセットは交換可能
   保護者の過半数が新しい保護者セットに署名して公開することに同意した場合。
  
 -ゴシップネットワーク上でそれを識別する**ノードキー**。SolanaのノードIDまたはTendermintに似ています。
   ノードキー。これは、ルーティングおよびトランスポート層の暗号化のためにピアツーピアネットワークによって使用されます。
   攻撃者はこれを使用して、ネットワーク上のメッセージを検閲する可能性があります。それ以外はあまりありません
   重要であり、回転させることができます。ノードは、存在しない場合、指定したパスにノードキーを自動的に作成します。
 
本番環境では、ディスクを暗号化するか、キーがディスクに触れないように注意することを強くお勧めします。
達成する1つの方法は、スワップアウトできないメモリ内のramfsにキーを格納し、コールドから復元することです。
ノードが再起動されるたびに、ストレージまたはHSM/ボールト。スワップを完全に無効にすることをお勧めします。そのどれも
ワームホールに固有-これはすべてのホットキーに適用されます。

私たちのノードソフトウェアは、キーがディスクにスワップアウトされないように、mlock(2)を使用してメモリをロックするように細心の注意を払っています。
それが追加の機能を必要とする理由です。はい、他のチェーンもこれをしたいかもしれません:-)

キーをHSMに保存するか、リモート署名者を使用すると、サーバーの侵害のリスクが部分的に軽減されます。つまり、キーを意味します。
盗まれることはありませんが、攻撃者はHSMに悪意のあるペイロードに署名させる可能性があります。ワームホールの将来の反復
[SignOS](https://certus.one/sign-os/)などの署名者を使用したリモート署名のサポートが含まれる場合があります。